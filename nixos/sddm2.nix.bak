{
  config,
  lib,
  pkgs,
  inputs,
  ...
}:
with lib; let
  cfg = config.custom.sddm;
in {
  options.custom.sddm = {
    enable = mkEnableOption "Enable SDDM display manager for Hyprland";
  };

  config = mkIf cfg.enable {
    services.displayManager.sddm = {
      enable = true;
      wayland.enable = true;
      theme = "catppuccin-mocha";
      settings = {
        General = {
          DefaultSession = "hyprland.desktop"; # Note: must match .desktop name
          DisplayServer = "wayland";
          Numlock = "on";
          RememberLastUser = true;
          RememberLastSession = true;
          LoginTimeout = 60;
          SessionTimeout = 30;
          GreeterEnvironment = "QT_WAYLAND_FORCE_DPI=physical;QT_WAYLAND_DISABLE_WINDOWDECORATION=1";
        };
        Users = {
          MinimumUid = 1000;
          MaximumUid = 60000;
          HideUsers = "";
          HideShells = "/bin/false,/usr/bin/nologin,/sbin/nologin";
          RememberLastUser = true;
        };
        Wayland = {
          SessionDir = "${
            inputs.hyprland.packages."${pkgs.system}".hyprland
          }/share/wayland-sessions";
          # SessionDir = "/run/current-system/sw/share/wayland-sessions";
          CompositorCommand = "kwin_wayland --no-lockscreen --no-global-shortcuts --locale1";
          # CompositorCommand = ""; # Commented unless custom SDDM greeter compositor needed
        };
      };
    };

    environment.systemPackages = with pkgs; [
      (catppuccin-sddm.override {
        flavor = "mocha";
        font = "Inter";
        fontSize = "12";
        background = "${inputs.wallpapers}/Wall.png";
        loginBackground = true;
      })
      libsForQt5.qt5.qtquickcontrols2
      libsForQt5.qt5.qtgraphicaleffects
      libsForQt5.qt5.qtsvg
      libsForQt5.qt5.qtmultimedia
      inter
    ];

    environment.etc."sddm/wallpaper.jpg".source = "${inputs.wallpapers}/Wall.png";

    services.displayManager.sessionPackages = [pkgs.hyprland];

    # Enable SDDM with GNOME keyring integration if needed
    security.pam.services.sddm.enableGnomeKeyring = true;
    security.pam.services.sddm-greeter.enableGnomeKeyring = true;

    security.polkit.enable = true;

    # Fix for missing /etc/environment variables to greeter
    # environment.sessionVariables = {
    #   QT_QPA_PLATFORM = "wayland";
    #   QT_WAYLAND_DISABLE_WINDOWDECORATION = "1";
    #   QT_WAYLAND_FORCE_DPI = "physical";
    # };
  };
}
